From 6b2af9d106966024ebe7d4f8bbc52c25b19d7b87 Mon Sep 17 00:00:00 2001
From: Angelo Fallaria <ba.fallaria@gmail.com>
Date: Mon, 12 Feb 2024 17:28:41 +0800
Subject: [PATCH] feat(mux): add 1.22-style path value support

---
 mux.go                 |  4 +++
 path_value.go          | 20 ++++++++++++
 path_value_fallback.go | 19 ++++++++++++
 path_value_test.go     | 69 ++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 112 insertions(+)
 create mode 100644 path_value.go
 create mode 100644 path_value_fallback.go
 create mode 100644 path_value_test.go

diff --git a/mux.go b/mux.go
index 56fa4d28..931f7d0c 100644
--- a/mux.go
+++ b/mux.go
@@ -454,6 +454,10 @@ func (mx *Mux) routeHTTP(w http.ResponseWriter, r *http.Request) {
 
 	// Find the route
 	if _, _, h := mx.tree.FindRoute(rctx, method, routePath); h != nil {
+		if supportsPathValue {
+			setPathValue(rctx, r)
+		}
+
 		h.ServeHTTP(w, r)
 		return
 	}
diff --git a/path_value.go b/path_value.go
new file mode 100644
index 00000000..7e78171e
--- /dev/null
+++ b/path_value.go
@@ -0,0 +1,20 @@
+//go:build go1.22
+// +build go1.22
+
+package chi
+
+import "net/http"
+
+// supportsPathValue is true if the Go version is 1.22 and above.
+//
+// If this is true, `net/http.Request` has methods `SetPathValue` and `PathValue`.
+const supportsPathValue = true
+
+// setPathValue sets the path values in the Request value
+// based on the provided request context.
+func setPathValue(rctx *Context, r *http.Request) {
+	for i, key := range rctx.URLParams.Keys {
+		value := rctx.URLParams.Values[i]
+		r.SetPathValue(key, value)
+	}
+}
diff --git a/path_value_fallback.go b/path_value_fallback.go
new file mode 100644
index 00000000..f551781a
--- /dev/null
+++ b/path_value_fallback.go
@@ -0,0 +1,19 @@
+//go:build !go1.22
+// +build !go1.22
+
+package chi
+
+import "net/http"
+
+// supportsPathValue is true if the Go version is 1.22 and above.
+//
+// If this is true, `net/http.Request` has methods `SetPathValue` and `PathValue`.
+const supportsPathValue = false
+
+// setPathValue sets the path values in the Request value
+// based on the provided request context.
+//
+// setPathValue is only supported in Go 1.22 and above so
+// this is just a blank function so that it compiles.
+func setPathValue(rctx *Context, r *http.Request) {
+}
