From 6b2af9d106966024ebe7d4f8bbc52c25b19d7b87 Mon Sep 17 00:00:00 2001
From: Angelo Fallaria <ba.fallaria@gmail.com>
Date: Mon, 12 Feb 2024 17:28:41 +0800
Subject: [PATCH] feat(mux): add 1.22-style path value support

---
 mux.go                 |  4 +++
 path_value.go          | 20 ++++++++++++
 path_value_fallback.go | 19 ++++++++++++
 path_value_test.go     | 69 ++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 112 insertions(+)
 create mode 100644 path_value.go
 create mode 100644 path_value_fallback.go
 create mode 100644 path_value_test.go

diff --git a/path_value_test.go b/path_value_test.go
new file mode 100644
index 00000000..389360ea
--- /dev/null
+++ b/path_value_test.go
@@ -0,0 +1,69 @@
+//go:build go1.22
+// +build go1.22
+
+package chi
+
+import (
+	"net/http"
+	"net/http/httptest"
+	"strings"
+	"testing"
+)
+
+func TestPathValue(t *testing.T) {
+	testCases := []struct {
+		name         string
+		pattern      string
+		method       string
+		pathKeys     []string
+		requestPath  string
+		expectedBody string
+	}{
+		{
+			name:         "Basic path value",
+			pattern:      "/hubs/{hubID}",
+			method:       "GET",
+			pathKeys:     []string{"hubID"},
+			requestPath:  "/hubs/392",
+			expectedBody: "392",
+		},
+		{
+			name:         "Two path values",
+			pattern:      "/users/{userID}/conversations/{conversationID}",
+			method:       "POST",
+			pathKeys:     []string{"userID", "conversationID"},
+			requestPath:  "/users/Gojo/conversations/2948",
+			expectedBody: "Gojo 2948",
+		},
+	}
+
+	for _, tc := range testCases {
+		t.Run(tc.name, func(t *testing.T) {
+			r := NewRouter()
+
+			r.Handle(tc.method+" "+tc.pattern, http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
+				pathValues := []string{}
+				for _, pathKey := range tc.pathKeys {
+					pathValue := r.PathValue(pathKey)
+					if pathValue == "" {
+						pathValue = "NOT_FOUND:" + pathKey
+					}
+
+					pathValues = append(pathValues, pathValue)
+				}
+
+				body := strings.Join(pathValues, " ")
+
+				w.Write([]byte(body))
+			}))
+
+			ts := httptest.NewServer(r)
+			defer ts.Close()
+
+			_, body := testRequest(t, ts, tc.method, tc.requestPath, nil)
+			if body != tc.expectedBody {
+				t.Fatalf("expecting %q, got %q", tc.expectedBody, body)
+			}
+		})
+	}
+}
