From f2a6ea8d53728b280d0c7730cb931a518841b0b2 Mon Sep 17 00:00:00 2001
From: Angelo Fallaria <ba.fallaria@gmail.com>
Date: Mon, 12 Feb 2024 15:58:14 +0800
Subject: [PATCH 1/5] refactor(mux.Handle): call `mux.Method` for 1.22 paths

---
 mux.go | 10 +---------
 1 file changed, 1 insertion(+), 9 deletions(-)

diff --git a/mux_test.go b/mux_test.go
index 9190cb5d..c606b68a 100644
--- a/mux_test.go
+++ b/mux_test.go
@@ -691,7 +691,7 @@ func TestMuxHandlePatternValidation(t *testing.T) {
 		t.Run(tc.name, func(t *testing.T) {
 			defer func() {
 				if r := recover(); r != nil && !tc.shouldPanic {
-					t.Errorf("Unexpected panic for pattern %s", tc.pattern)
+					t.Errorf("Unexpected panic for pattern %s:\n%v", tc.pattern, r)
 				}
 			}()
 

diff --git a/mux_test.go b/mux_test.go
index c606b68a..2ffa7770 100644
--- a/mux_test.go
+++ b/mux_test.go
@@ -711,6 +711,24 @@ func TestMuxHandlePatternValidation(t *testing.T) {
 						tc.expectedStatus, tc.expectedBody, resp.StatusCode, body, tc.pattern)
 				}
 			}
+
+			// Test that HandleFunc also handles method patterns
+			r = NewRouter()
+			r.HandleFunc(tc.pattern, func(w http.ResponseWriter, r *http.Request) {
+				w.Write([]byte(tc.expectedBody))
+			})
+
+			if !tc.shouldPanic {
+				// Use testRequest for valid patterns
+				ts := httptest.NewServer(r)
+				defer ts.Close()
+
+				resp, body := testRequest(t, ts, tc.method, tc.path, nil)
+				if body != tc.expectedBody || resp.StatusCode != tc.expectedStatus {
+					t.Errorf("Expected status %d and body %s; got status %d and body %s for pattern %s",
+						tc.expectedStatus, tc.expectedBody, resp.StatusCode, body, tc.pattern)
+				}
+			}
 		})
 	}
 }

diff --git a/mux_test.go b/mux_test.go
index 2ffa7770..82f089e7 100644
--- a/mux_test.go
+++ b/mux_test.go
@@ -695,38 +695,28 @@ func TestMuxHandlePatternValidation(t *testing.T) {
 				}
 			}()
 
-			r := NewRouter()
-			r.Handle(tc.pattern, http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
+			r1 := NewRouter()
+			r1.Handle(tc.pattern, http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
 				w.Write([]byte(tc.expectedBody))
 			}))
 
-			if !tc.shouldPanic {
-				// Use testRequest for valid patterns
-				ts := httptest.NewServer(r)
-				defer ts.Close()
-
-				resp, body := testRequest(t, ts, tc.method, tc.path, nil)
-				if body != tc.expectedBody || resp.StatusCode != tc.expectedStatus {
-					t.Errorf("Expected status %d and body %s; got status %d and body %s for pattern %s",
-						tc.expectedStatus, tc.expectedBody, resp.StatusCode, body, tc.pattern)
-				}
-			}
-
 			// Test that HandleFunc also handles method patterns
-			r = NewRouter()
-			r.HandleFunc(tc.pattern, func(w http.ResponseWriter, r *http.Request) {
+			r2 := NewRouter()
+			r2.HandleFunc(tc.pattern, func(w http.ResponseWriter, r *http.Request) {
 				w.Write([]byte(tc.expectedBody))
 			})
 
 			if !tc.shouldPanic {
-				// Use testRequest for valid patterns
-				ts := httptest.NewServer(r)
-				defer ts.Close()
-
-				resp, body := testRequest(t, ts, tc.method, tc.path, nil)
-				if body != tc.expectedBody || resp.StatusCode != tc.expectedStatus {
-					t.Errorf("Expected status %d and body %s; got status %d and body %s for pattern %s",
-						tc.expectedStatus, tc.expectedBody, resp.StatusCode, body, tc.pattern)
+				for _, r := range []Router{r1, r2} {
+					// Use testRequest for valid patterns
+					ts := httptest.NewServer(r)
+					defer ts.Close()
+
+					resp, body := testRequest(t, ts, tc.method, tc.path, nil)
+					if body != tc.expectedBody || resp.StatusCode != tc.expectedStatus {
+						t.Errorf("Expected status %d and body %s; got status %d and body %s for pattern %s",
+							tc.expectedStatus, tc.expectedBody, resp.StatusCode, body, tc.pattern)
+					}
 				}
 			}
 		})
