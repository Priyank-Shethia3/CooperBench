diff --git a/tests/test_async_filters.py b/tests/test_async_filters.py
index 5d4f332e..4a9ddff3 100644
--- a/tests/test_async_filters.py
+++ b/tests/test_async_filters.py
@@ -251,3 +251,104 @@ def test_custom_async_iteratable_filter(env_async, items):
     )
     out = tmpl.render(items=items)
     assert out == "0,1,2 .. 3,4,5"
+
+
+def make_multilevel_users():
+    return [
+        {"name": "alice", "department": "eng", "role": "dev"},
+        {"name": "bob", "department": "eng", "role": "dev"},
+        {"name": "charlie", "department": "eng", "role": "manager"},
+        {"name": "diana", "department": "sales", "role": "rep"},
+        {"name": "eve", "department": "sales", "role": "manager"},
+    ]
+
+
+@mark_dualiter("users", make_multilevel_users)
+def test_groupby_multilevel_basic(env_async, users):
+    """Test basic multi-level grouping with 2 levels in async mode."""
+    tmpl = env_async.from_string(
+        "{% for dept_group in users()|groupby(['department', 'role'], levels=2) %}"
+        "{{ dept_group.grouper }}:\n"
+        "{% for role_group in dept_group.list %}"
+        "  {{ role_group.grouper }}: {{ role_group.list|map(attribute='name')|join(', ') }}\n"
+        "{% endfor %}"
+        "{% endfor %}"
+    )
+    out = tmpl.render(users=users)
+    expected = (
+        "eng:\n"
+        "  dev: alice, bob\n"
+        "  manager: charlie\n"
+        "sales:\n"
+        "  manager: eve\n"
+        "  rep: diana\n"
+    )
+    assert out == expected
+
+
+def make_three_level_data():
+    return [
+        {"a": "x", "b": "1", "c": "i", "value": "A"},
+        {"a": "x", "b": "1", "c": "ii", "value": "B"},
+        {"a": "x", "b": "2", "c": "i", "value": "C"},
+        {"a": "y", "b": "1", "c": "i", "value": "D"},
+    ]
+
+
+@mark_dualiter("data", make_three_level_data)
+def test_groupby_multilevel_three_levels(env_async, data):
+    """Test multi-level grouping with 3 levels in async mode."""
+    tmpl = env_async.from_string(
+        "{% for l1 in data()|groupby(['a', 'b', 'c'], levels=3) %}"
+        "{{ l1.grouper }}:\n"
+        "{% for l2 in l1.list %}"
+        "  {{ l2.grouper }}:\n"
+        "{% for l3 in l2.list %}"
+        "    {{ l3.grouper }}: {{ l3.list|map(attribute='value')|join(',') }}\n"
+        "{% endfor %}"
+        "{% endfor %}"
+        "{% endfor %}"
+    )
+    out = tmpl.render(data=data)
+    expected = (
+        "x:\n"
+        "  1:\n"
+        "    i: A\n"
+        "    ii: B\n"
+        "  2:\n"
+        "    i: C\n"
+        "y:\n"
+        "  1:\n"
+        "    i: D\n"
+    )
+    assert out == expected
+
+
+def test_groupby_multilevel_empty_data(env_async):
+    """Test multi-level grouping with empty data in async mode."""
+    tmpl = env_async.from_string(
+        "{% for group in []|groupby(['a', 'b'], levels=2) %}"
+        "{{ group.grouper }}\n"
+        "{% else %}"
+        "No data\n"
+        "{% endfor %}"
+    )
+    out = tmpl.render()
+    assert out == "No data\n"
+
+
+def test_groupby_multilevel_backward_compatibility(env_async):
+    """Test that single-level groupby still works in async mode."""
+    tmpl = env_async.from_string(
+        "{% for group in data|groupby('category') %}"
+        "{{ group.grouper }}: {{ group.list|map(attribute='name')|join(', ') }}\n"
+        "{% endfor %}"
+    )
+    data = [
+        {"name": "apple", "category": "fruit"},
+        {"name": "banana", "category": "fruit"},
+        {"name": "carrot", "category": "vegetable"},
+    ]
+    out = tmpl.render(data=data)
+    expected = "fruit: apple, banana\nvegetable: carrot\n"
+    assert out == expected
diff --git a/tests/test_filters.py b/tests/test_filters.py
index 43ddf59c..b4ead939 100644
--- a/tests/test_filters.py
+++ b/tests/test_filters.py
@@ -65,27 +65,19 @@ class TestFilter:
     def test_batch(self, env):
         tmpl = env.from_string("{{ foo|batch(3)|list }}|{{ foo|batch(3, 'X')|list }}")
         out = tmpl.render(foo=list(range(10)))
-        assert out == (
-            "[[0, 1, 2], [3, 4, 5], [6, 7, 8], [9]]|"
-            "[[0, 1, 2], [3, 4, 5], [6, 7, 8], [9, 'X', 'X']]"
-        )
+        assert out == ("[[0, 1, 2], [3, 4, 5], [6, 7, 8], [9]]|[[0, 1, 2], [3, 4, 5], [6, 7, 8], [9, 'X', 'X']]")
 
     def test_slice(self, env):
         tmpl = env.from_string("{{ foo|slice(3)|list }}|{{ foo|slice(3, 'X')|list }}")
         out = tmpl.render(foo=list(range(10)))
-        assert out == (
-            "[[0, 1, 2, 3], [4, 5, 6], [7, 8, 9]]|"
-            "[[0, 1, 2, 3], [4, 5, 6, 'X'], [7, 8, 9, 'X']]"
-        )
+        assert out == ("[[0, 1, 2, 3], [4, 5, 6], [7, 8, 9]]|[[0, 1, 2, 3], [4, 5, 6, 'X'], [7, 8, 9, 'X']]")
 
     def test_escape(self, env):
         tmpl = env.from_string("""{{ '<">&'|escape }}""")
         out = tmpl.render()
         assert out == "&lt;&#34;&gt;&amp;"
 
-    @pytest.mark.parametrize(
-        ("chars", "expect"), [(None, "..stays.."), (".", "  ..stays"), (" .", "stays")]
-    )
+    @pytest.mark.parametrize(("chars", "expect"), [(None, "..stays.."), (".", "  ..stays"), (" .", "stays")])
     def test_trim(self, env, chars, expect):
         tmpl = env.from_string("{{ foo|trim(chars) }}")
         out = tmpl.render(foo="  ..stays..", chars=chars)
@@ -114,10 +106,7 @@ class TestFilter:
             "{{ 1000000000000|filesizeformat(true) }}"
         )
         out = tmpl.render()
-        assert out == (
-            "100 Bytes|1.0 kB|1.0 MB|1.0 GB|1.0 TB|100 Bytes|"
-            "1000 Bytes|976.6 KiB|953.7 MiB|931.3 GiB"
-        )
+        assert out == ("100 Bytes|1.0 kB|1.0 MB|1.0 GB|1.0 TB|100 Bytes|1000 Bytes|976.6 KiB|953.7 MiB|931.3 GiB")
 
     def test_filesizeformat_issue59(self, env):
         tmpl = env.from_string(
@@ -131,18 +120,14 @@ class TestFilter:
             "{{ 3000000|filesizeformat(true) }}"
         )
         out = tmpl.render()
-        assert out == (
-            "300 Bytes|3.0 kB|3.0 MB|3.0 GB|3.0 TB|300 Bytes|2.9 KiB|2.9 MiB"
-        )
+        assert out == ("300 Bytes|3.0 kB|3.0 MB|3.0 GB|3.0 TB|300 Bytes|2.9 KiB|2.9 MiB")
 
     def test_first(self, env):
         tmpl = env.from_string("{{ foo|first }}")
         out = tmpl.render(foo=list(range(10)))
         assert out == "0"
 
-    @pytest.mark.parametrize(
-        ("value", "expect"), (("42", "42.0"), ("abc", "0.0"), ("32.32", "32.32"))
-    )
+    @pytest.mark.parametrize(("value", "expect"), (("42", "42.0"), ("abc", "0.0"), ("32.32", "32.32")))
     def test_float(self, env, value, expect):
         t = env.from_string("{{ value|float }}")
         assert t.render(value=value) == expect
@@ -286,9 +271,7 @@ class TestFilter:
             assert t.render() == value
 
     def test_reverse(self, env):
-        tmpl = env.from_string(
-            "{{ 'foobar'|reverse|join }}|{{ [1, 2, 3]|reverse|list }}"
-        )
+        tmpl = env.from_string("{{ 'foobar'|reverse|join }}|{{ [1, 2, 3]|reverse|list }}")
         assert tmpl.render() == "raboof|[3, 2, 1]"
 
     def test_string(self, env):
@@ -330,17 +313,13 @@ class TestFilter:
 
     def test_truncate(self, env):
         tmpl = env.from_string(
-            '{{ data|truncate(15, true, ">>>") }}|'
-            '{{ data|truncate(15, false, ">>>") }}|'
-            "{{ smalldata|truncate(15) }}"
+            '{{ data|truncate(15, true, ">>>") }}|{{ data|truncate(15, false, ">>>") }}|{{ smalldata|truncate(15) }}'
         )
         out = tmpl.render(data="foobar baz bar" * 1000, smalldata="foobar baz bar")
         assert out == "foobar baz b>>>|foobar baz>>>|foobar baz bar"
 
     def test_truncate_very_short(self, env):
-        tmpl = env.from_string(
-            '{{ "foo bar baz"|truncate(9) }}|{{ "foo bar baz"|truncate(9, true) }}'
-        )
+        tmpl = env.from_string('{{ "foo bar baz"|truncate(9) }}|{{ "foo bar baz"|truncate(9, true) }}')
         out = tmpl.render()
         assert out == "foo bar baz|foo bar baz"
 
@@ -355,45 +334,30 @@ class TestFilter:
 
     def test_urlize(self, env):
         tmpl = env.from_string('{{ "foo example.org bar"|urlize }}')
-        assert tmpl.render() == (
-            'foo <a href="https://example.org" rel="noopener">' "example.org</a> bar"
-        )
+        assert tmpl.render() == ('foo <a href="https://example.org" rel="noopener">example.org</a> bar')
         tmpl = env.from_string('{{ "foo http://www.example.com/ bar"|urlize }}')
-        assert tmpl.render() == (
-            'foo <a href="http://www.example.com/" rel="noopener">'
-            "http://www.example.com/</a> bar"
-        )
+        assert tmpl.render() == ('foo <a href="http://www.example.com/" rel="noopener">http://www.example.com/</a> bar')
         tmpl = env.from_string('{{ "foo mailto:email@example.com bar"|urlize }}')
-        assert tmpl.render() == (
-            'foo <a href="mailto:email@example.com">email@example.com</a> bar'
-        )
+        assert tmpl.render() == ('foo <a href="mailto:email@example.com">email@example.com</a> bar')
         tmpl = env.from_string('{{ "foo email@example.com bar"|urlize }}')
-        assert tmpl.render() == (
-            'foo <a href="mailto:email@example.com">email@example.com</a> bar'
-        )
+        assert tmpl.render() == ('foo <a href="mailto:email@example.com">email@example.com</a> bar')
 
     def test_urlize_rel_policy(self):
         env = Environment()
         env.policies["urlize.rel"] = None
         tmpl = env.from_string('{{ "foo http://www.example.com/ bar"|urlize }}')
-        assert tmpl.render() == (
-            'foo <a href="http://www.example.com/">http://www.example.com/</a> bar'
-        )
+        assert tmpl.render() == ('foo <a href="http://www.example.com/">http://www.example.com/</a> bar')
 
     def test_urlize_target_parameter(self, env):
-        tmpl = env.from_string(
-            '{{ "foo http://www.example.com/ bar"|urlize(target="_blank") }}'
-        )
+        tmpl = env.from_string('{{ "foo http://www.example.com/ bar"|urlize(target="_blank") }}')
         assert (
-            tmpl.render()
-            == 'foo <a href="http://www.example.com/" rel="noopener" target="_blank">'
+            tmpl.render() == 'foo <a href="http://www.example.com/" rel="noopener" target="_blank">'
             "http://www.example.com/</a> bar"
         )
 
     def test_urlize_extra_schemes_parameter(self, env):
         tmpl = env.from_string(
-            '{{ "foo tel:+1-514-555-1234 ftp://localhost bar"|'
-            'urlize(extra_schemes=["tel:", "ftp:"]) }}'
+            '{{ "foo tel:+1-514-555-1234 ftp://localhost bar"|urlize(extra_schemes=["tel:", "ftp:"]) }}'
         )
         assert tmpl.render() == (
             'foo <a href="tel:+1-514-555-1234" rel="noopener">'
@@ -449,24 +413,17 @@ class TestFilter:
 
     def test_round_positive(self, env):
         tmpl = env.from_string(
-            "{{ 2.7|round }}|{{ 2.1|round }}|"
-            "{{ 2.1234|round(3, 'floor') }}|"
-            "{{ 2.1|round(0, 'ceil') }}"
+            "{{ 2.7|round }}|{{ 2.1|round }}|{{ 2.1234|round(3, 'floor') }}|{{ 2.1|round(0, 'ceil') }}"
         )
         assert tmpl.render() == "3.0|2.0|2.123|3.0", tmpl.render()
 
     def test_round_negative(self, env):
-        tmpl = env.from_string(
-            "{{ 21.3|round(-1)}}|"
-            "{{ 21.3|round(-1, 'ceil')}}|"
-            "{{ 21.3|round(-1, 'floor')}}"
-        )
+        tmpl = env.from_string("{{ 21.3|round(-1)}}|{{ 21.3|round(-1, 'ceil')}}|{{ 21.3|round(-1, 'floor')}}")
         assert tmpl.render() == "20.0|30.0|20.0", tmpl.render()
 
     def test_xmlattr(self, env):
         tmpl = env.from_string(
-            "{{ {'foo': 42, 'bar': 23, 'fish': none, "
-            "'spam': missing, 'blub:blub': '<?>'}|xmlattr }}"
+            "{{ {'foo': 42, 'bar': 23, 'fish': none, 'spam': missing, 'blub:blub': '<?>'}|xmlattr }}"
         )
         out = tmpl.render().split()
         assert len(out) == 3
@@ -497,29 +454,19 @@ class TestFilter:
     def test_sort6(self, env):
         tmpl = env.from_string("""{{ items|sort(attribute='value1,value2')|join }}""")
         assert (
-            tmpl.render(
-                items=map(
-                    lambda x: Magic2(x[0], x[1]), [(3, 1), (2, 2), (2, 1), (2, 5)]
-                )
-            )
+            tmpl.render(items=map(lambda x: Magic2(x[0], x[1]), [(3, 1), (2, 2), (2, 1), (2, 5)]))
             == "(2,1)(2,2)(2,5)(3,1)"
         )
 
     def test_sort7(self, env):
         tmpl = env.from_string("""{{ items|sort(attribute='value2,value1')|join }}""")
         assert (
-            tmpl.render(
-                items=map(
-                    lambda x: Magic2(x[0], x[1]), [(3, 1), (2, 2), (2, 1), (2, 5)]
-                )
-            )
+            tmpl.render(items=map(lambda x: Magic2(x[0], x[1]), [(3, 1), (2, 2), (2, 1), (2, 5)]))
             == "(2,1)(3,1)(2,2)(2,5)"
         )
 
     def test_sort8(self, env):
-        tmpl = env.from_string(
-            """{{ items|sort(attribute='value1.0,value2.0')|join }}"""
-        )
+        tmpl = env.from_string("""{{ items|sort(attribute='value1.0,value2.0')|join }}""")
         assert (
             tmpl.render(
                 items=map(
@@ -619,10 +566,145 @@ class TestFilter:
         )
         assert out == "NY: emma, john\nWA: smith\n"
 
-    def test_filtertag(self, env):
+    def test_groupby_multilevel_basic(self, env):
+        """Test basic multi-level grouping with 2 levels."""
+        tmpl = env.from_string(
+            "{% for dept_group in users|groupby(['department', 'role'], levels=2) %}"
+            "{{ dept_group.grouper }}:\n"
+            "{% for role_group in dept_group.list %}"
+            "  {{ role_group.grouper }}: {{ role_group.list|map(attribute='name')|join(', ') }}\n"
+            "{% endfor %}"
+            "{% endfor %}"
+        )
+        users = [
+            {"name": "alice", "department": "eng", "role": "dev"},
+            {"name": "bob", "department": "eng", "role": "dev"},
+            {"name": "charlie", "department": "eng", "role": "manager"},
+            {"name": "diana", "department": "sales", "role": "rep"},
+            {"name": "eve", "department": "sales", "role": "manager"},
+        ]
+        out = tmpl.render(users=users)
+        expected = "eng:\n  dev: alice, bob\n  manager: charlie\nsales:\n  manager: eve\n  rep: diana\n"
+        assert out == expected
+
+    def test_groupby_multilevel_three_levels(self, env):
+        """Test multi-level grouping with 3 levels."""
+        tmpl = env.from_string(
+            "{% for l1 in data|groupby(['a', 'b', 'c'], levels=3) %}"
+            "{{ l1.grouper }}:\n"
+            "{% for l2 in l1.list %}"
+            "  {{ l2.grouper }}:\n"
+            "{% for l3 in l2.list %}"
+            "    {{ l3.grouper }}: {{ l3.list|map(attribute='value')|join(',') }}\n"
+            "{% endfor %}"
+            "{% endfor %}"
+            "{% endfor %}"
+        )
+        data = [
+            {"a": "x", "b": "1", "c": "i", "value": "A"},
+            {"a": "x", "b": "1", "c": "ii", "value": "B"},
+            {"a": "x", "b": "2", "c": "i", "value": "C"},
+            {"a": "y", "b": "1", "c": "i", "value": "D"},
+        ]
+        out = tmpl.render(data=data)
+        expected = "x:\n  1:\n    i: A\n    ii: B\n  2:\n    i: C\ny:\n  1:\n    i: D\n"
+        assert out == expected
+
+    def test_groupby_multilevel_with_default(self, env):
+        """Test multi-level grouping with default values."""
+        tmpl = env.from_string(
+            "{% for dept_group in users|groupby(['department', 'role'], levels=2, default='unknown') %}"
+            "{{ dept_group.grouper }}:\n"
+            "{% for role_group in dept_group.list %}"
+            "  {{ role_group.grouper }}: {{ role_group.list|map(attribute='name')|join(', ') }}\n"
+            "{% endfor %}"
+            "{% endfor %}"
+        )
+        users = [
+            {"name": "alice", "department": "eng", "role": "dev"},
+            {"name": "bob", "department": "eng"},  # missing role
+            {"name": "charlie", "role": "manager"},  # missing department
+            {"name": "diana"},  # missing both
+        ]
+        out = tmpl.render(users=users)
+        expected = "eng:\n  dev: alice\n  unknown: bob\nunknown:\n  manager: charlie\n  unknown: diana\n"
+        assert out == expected
+
+    def test_groupby_multilevel_empty_data(self, env):
+        """Test multi-level grouping with empty data."""
+        tmpl = env.from_string(
+            "{% for group in data|groupby(['a', 'b'], levels=2) %}{{ group.grouper }}\n{% else %}No data\n{% endfor %}"
+        )
+        out = tmpl.render(data=[])
+        assert out == "No data\n"
+
+    def test_groupby_multilevel_single_item(self, env):
+        """Test multi-level grouping with single item."""
+        tmpl = env.from_string(
+            "{% for l1 in data|groupby(['a', 'b'], levels=2) %}"
+            "{{ l1.grouper }}:\n"
+            "{% for l2 in l1.list %}"
+            "  {{ l2.grouper }}: {{ l2.list|map(attribute='value')|join(',') }}\n"
+            "{% endfor %}"
+            "{% endfor %}"
+        )
+        data = [{"a": "x", "b": "y", "value": "test"}]
+        out = tmpl.render(data=data)
+        expected = "x:\n  y: test\n"
+        assert out == expected
+
+    def test_groupby_multilevel_dot_notation(self, env):
+        """Test multi-level grouping with dot notation attributes."""
+        tmpl = env.from_string(
+            "{% for l1 in data|groupby(['obj.a', 'obj.b'], levels=2) %}"
+            "{{ l1.grouper }}:\n"
+            "{% for l2 in l1.list %}"
+            "  {{ l2.grouper }}: {{ l2.list|map(attribute='value')|join(',') }}\n"
+            "{% endfor %}"
+            "{% endfor %}"
+        )
+        data = [
+            {"obj": {"a": "x", "b": "1"}, "value": "A"},
+            {"obj": {"a": "x", "b": "2"}, "value": "B"},
+            {"obj": {"a": "y", "b": "1"}, "value": "C"},
+        ]
+        out = tmpl.render(data=data)
+        expected = "x:\n  1: A\n  2: B\ny:\n  1: C\n"
+        assert out == expected
+
+    def test_groupby_backward_compatibility(self, env):
+        """Test that single-level groupby still works as before."""
+        tmpl = env.from_string(
+            "{% for group in data|groupby('category') %}"
+            "{{ group.grouper }}: {{ group.list|map(attribute='name')|join(', ') }}\n"
+            "{% endfor %}"
+        )
+        data = [
+            {"name": "apple", "category": "fruit"},
+            {"name": "banana", "category": "fruit"},
+            {"name": "carrot", "category": "vegetable"},
+        ]
+        out = tmpl.render(data=data)
+        expected = "fruit: apple, banana\nvegetable: carrot\n"
+        assert out == expected
+
+    def test_groupby_single_attribute_list(self, env):
+        """Test that single attribute in list works without levels."""
         tmpl = env.from_string(
-            "{% filter upper|replace('FOO', 'foo') %}foobar{% endfilter %}"
+            "{% for group in data|groupby(['category']) %}"
+            "{{ group.grouper }}: {{ group.list|map(attribute='name')|join(', ') }}\n"
+            "{% endfor %}"
         )
+        data = [
+            {"name": "apple", "category": "fruit"},
+            {"name": "banana", "category": "fruit"},
+        ]
+        out = tmpl.render(data=data)
+        expected = "fruit: apple, banana\n"
+        assert out == expected
+
+    def test_filtertag(self, env):
+        tmpl = env.from_string("{% filter upper|replace('FOO', 'foo') %}foobar{% endfilter %}")
         assert tmpl.render() == "fooBAR"
 
     def test_replace(self, env):
@@ -695,15 +777,9 @@ class TestFilter:
         Fullname = namedtuple("Fullname", "firstname,lastname")
         Firstname = namedtuple("Firstname", "firstname")
         env = Environment()
-        tmpl = env.from_string(
-            '{{ users|map(attribute="lastname", default="smith")|join(", ") }}'
-        )
-        test_list = env.from_string(
-            '{{ users|map(attribute="lastname", default=["smith","x"])|join(", ") }}'
-        )
-        test_str = env.from_string(
-            '{{ users|map(attribute="lastname", default="")|join(", ") }}'
-        )
+        tmpl = env.from_string('{{ users|map(attribute="lastname", default="smith")|join(", ") }}')
+        test_list = env.from_string('{{ users|map(attribute="lastname", default=["smith","x"])|join(", ") }}')
+        test_str = env.from_string('{{ users|map(attribute="lastname", default="")|join(", ") }}')
         users = [
             Fullname("john", "lennon"),
             Fullname("jane", "edwards"),
@@ -742,9 +818,7 @@ class TestFilter:
             User("jane", True),
             User("mike", False),
         ]
-        tmpl = env.from_string(
-            '{{ users|selectattr("is_active")|map(attribute="name")|join("|") }}'
-        )
+        tmpl = env.from_string('{{ users|selectattr("is_active")|map(attribute="name")|join("|") }}')
         assert tmpl.render(users=users) == "john|jane"
 
     def test_simple_reject_attr(self, env):
@@ -755,9 +829,7 @@ class TestFilter:
             User("jane", True),
             User("mike", False),
         ]
-        tmpl = env.from_string(
-            '{{ users|rejectattr("is_active")|map(attribute="name")|join("|") }}'
-        )
+        tmpl = env.from_string('{{ users|rejectattr("is_active")|map(attribute="name")|join("|") }}')
         assert tmpl.render(users=users) == "mike"
 
     def test_func_select_attr(self, env):
@@ -768,9 +840,7 @@ class TestFilter:
             User(2, "jane"),
             User(3, "mike"),
         ]
-        tmpl = env.from_string(
-            '{{ users|selectattr("id", "odd")|map(attribute="name")|join("|") }}'
-        )
+        tmpl = env.from_string('{{ users|selectattr("id", "odd")|map(attribute="name")|join("|") }}')
         assert tmpl.render(users=users) == "john|mike"
 
     def test_func_reject_attr(self, env):
@@ -781,9 +851,7 @@ class TestFilter:
             User(2, "jane"),
             User(3, "mike"),
         ]
-        tmpl = env.from_string(
-            '{{ users|rejectattr("id", "odd")|map(attribute="name")|join("|") }}'
-        )
+        tmpl = env.from_string('{{ users|rejectattr("id", "odd")|map(attribute="name")|join("|") }}')
         assert tmpl.render(users=users) == "jane"
 
     def test_json_dump(self):
@@ -819,17 +887,14 @@ class TestFilter:
 
     def test_filter_undefined_in_elif(self, env):
         t = env.from_string(
-            "{%- if x is defined -%}{{ x }}{%- elif y is defined -%}"
-            "{{ y|f }}{%- else -%}foo{%- endif -%}"
+            "{%- if x is defined -%}{{ x }}{%- elif y is defined -%}{{ y|f }}{%- else -%}foo{%- endif -%}"
         )
         assert t.render() == "foo"
         with pytest.raises(TemplateRuntimeError, match="No filter named 'f'"):
             t.render(y=42)
 
     def test_filter_undefined_in_else(self, env):
-        t = env.from_string(
-            "{%- if x is not defined -%}foo{%- else -%}{{ x|f }}{%- endif -%}"
-        )
+        t = env.from_string("{%- if x is not defined -%}foo{%- else -%}{{ x|f }}{%- endif -%}")
         assert t.render() == "foo"
         with pytest.raises(TemplateRuntimeError, match="No filter named 'f'"):
             t.render(x=42)
